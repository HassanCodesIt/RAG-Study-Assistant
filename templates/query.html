<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RAG Study Assistant - Query</title>
  <link rel="stylesheet" href="/static/css/styles.css">
</head>

<body>
  <div class="container">
    <div class="card">
      <h1>Ask Your Study Assistant</h1>

      <form onsubmit="handleQuery(event)">
        <label for="subject">Subject</label>
        <select id="subject" name="subject">
          <!-- Populated by JS -->
        </select>

        <label for="query">Your Question</label>
        <textarea id="query" name="user_query" placeholder="What would you like to know?"></textarea>

        <button type="submit" id="submit-btn">
          <span id="btn-text">Ask Question</span>
        </button>
      </form>

      <div id="answer" class="answer-box" style="display: none;"></div>

      <a href="/" class="nav-link">&larr; Back to Upload</a>
    </div>
  </div>

  <script>
    function loadSubjects() {
      const subjectSelect = document.getElementById("subject");
      subjectSelect.innerHTML = "";

      const defaultSubjects = ["physics", "chemistry"];
      const savedSubjects = JSON.parse(localStorage.getItem("subjects")) || [];
      const allSubjects = [...new Set([...defaultSubjects, ...savedSubjects])];

      const placeholder = document.createElement("option");
      placeholder.value = "";
      placeholder.textContent = "Select a subject...";
      subjectSelect.appendChild(placeholder);

      allSubjects.forEach(sub => {
        const option = document.createElement("option");
        option.value = sub.toLowerCase();
        option.textContent = sub.charAt(0).toUpperCase() + sub.slice(1);
        subjectSelect.appendChild(option);
      });
    }

    async function handleQuery(event) {
      event.preventDefault();

      const subject = document.getElementById("subject").value.trim();
      const userQuery = document.getElementById("query").value.trim();
      const answerBox = document.getElementById("answer");
      const submitBtn = document.getElementById("submit-btn");
      const btnText = document.getElementById("btn-text");

      if (!subject) {
        alert("Please select a subject!");
        return;
      }
      if (!userQuery) {
        alert("Please enter a question!");
        return;
      }

      // UI Loading State
      submitBtn.disabled = true;
      btnText.innerHTML = '<span class="spinner"></span> Thinking...';
      answerBox.style.display = "block";
      answerBox.innerHTML = "<em>Analyzing documents...</em>";

      try {
        const formData = new FormData();
        formData.append("subject", subject);
        formData.append("user_query", userQuery);

        const response = await fetch("/query", {
          method: "POST",
          body: formData
        });

        if (!response.ok) {
          throw new Error("Server error: " + response.status);
        }

        const data = await response.json();
        answerBox.innerHTML = `
                    <h3>Answer:</h3>
                    <div class="answer-content">${data.response}</div>
                `;
      } catch (error) {
        console.error(error);
        answerBox.innerHTML = `<p style="color:var(--error-color);">Error: ${error.message}</p>`;
      } finally {
        submitBtn.disabled = false;
        btnText.textContent = "Ask Question";
      }
    }

    window.onload = loadSubjects;
  </script>
</body>

</html>